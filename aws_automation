pipeline {
    agent any
    
    environment {
        // Define AWS CLI environment variables
        AWS_REGION = 'us-west-2'  // Specify the AWS region
    }

    stages {
        stage('Delete EC2 Instances') {
            steps {
                script {
                    // Set AWS CLI credentials (Ensure IAM Role has sufficient permissions to terminate EC2 instances)
                    withAWS(region: AWS_REGION, credentials: 'aws-credentials') {
                        // Get a list of EC2 instances
                        def instances = sh(script: "aws ec2 describe-instances --query 'Reservations[].Instances[].[InstanceId,LaunchTime]' --output json", returnStdout: true).trim()

                        // Parse the JSON response and filter instances older than 30 days
                        def instancesJson = readJSON text: instances
                        def currentTime = new Date().time / 1000  // Current time in seconds
                        def thirtyDaysInSeconds = 30 * 24 * 60 * 60  // 30 days in seconds
                        
                        def instancesToTerminate = []

                        instancesJson.each { reservation ->
                            reservation.each { instance ->
                                def launchTime = new Date(instance[1]).time / 1000  // Convert LaunchTime to seconds
                                def instanceAge = currentTime - launchTime
                                
                                if (instanceAge > thirtyDaysInSeconds) {
                                    instancesToTerminate.add(instance[0])  // Add InstanceId to list if older than 30 days
                                }
                            }
                        }

                        // If there are instances to terminate, terminate them
                        if (instancesToTerminate.size() > 0) {
                            echo "Terminating instances: ${instancesToTerminate.join(', ')}"
                            sh "aws ec2 terminate-instances --instance-ids ${instancesToTerminate.join(' ')}"
                        } else {
                            echo "No EC2 instances older than 30 days."
                        }
                    }
                }
            }
        }
    }
}
